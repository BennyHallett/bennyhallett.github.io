<!DOCTYPE html>
<html>
  <head>
    <title>Benny Hallett | eat sleep code repeat</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/0reset.css" />
<link rel="stylesheet" href="assets/css/1skeleton.css" />
<link rel="stylesheet" href="assets/css/style.css" />
<link rel="stylesheet" href="assets/css/syntax.css" />
    <link rel="stylesheet" href="assets/css/font-awesome/css/font-awesome.min.css" />
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono|Ubuntu' rel='stylesheet' type='text/css'>
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-9971151-1', 'bennyhallett.com');
        ga('send', 'pageview');

      </script>
  </head>

  <body>
    <div class="container">
      <div class="row header">
        <a href="http://bennyhallett.github.io"><img src="assets/img/profile.jpeg" alt="Benny Hallett" class="profile" /></a>
        <h1><a href="http://bennyhallett.github.io">Benny Hallett</a></h1>
        <h2>eat sleep code repeat</h2>
      </div>

      <div class="row main">
        <div class="twelve columns alpha">
          <div id="post">
  <h3 class="post-title"><a href="2014-09-15-parsing-and-transformation.html">Parsing and Transformation</a></h3>
  <p>If you’re yet to watch the <a href="http://www.confreaks.com/events/elixirconf2014">talks from ElixirConf</a>, do yourself a favour and go check them out. The one’s I’ve seen so far have been amazing.</p>
<p>The first one that I watched is <a href="http://twitter.com/pragdave">Dave Thomas’</a> keynote talk <a href="http://www.confreaks.com/videos/4119-elixirconf2014-opening-keynote-think-different">Think Different(ly)</a>. This talk transformed the way I think about programming in Elixir. Dave explains how he tackles a new language by writing a <a href="http://daringfireball.net/projects/markdown/">Markdown</a> parser, and how he came to understand programming in Elixir as parsing and transformation.</p>
<p>Lets look at a simple example to get us started. Say we have an API, and we want to have our endpoint take an identifier, returning some information about cats. We want to keep it fairly clean, so we only return the information that the caller would expect from this call, rather than all the data that we have related to this identifier.</p>
<p>When we think about this, we have a few things we need to do:</p>
<ul>
<li>Receive the input
</li>
<li>Look up the record
</li>
<li>Select only the relevant cat information
</li>
<li>Turn it into JSON
</li>
<li>And send it back to the client
</li>
</ul>
<p>At the core of it, the processed described above is transforming one piece of information, <em>the identifier</em>, into another, <em>the JSON packet</em>.</p>
<p>We can make use of Elixir’s pipeline to make these transformations in an obvious way.</p>
<pre><code>defmodule My.Api do
  def get_data_about_cats(id) do
    id
    |&gt; load_record
    |&gt; select_cat_info
    |&gt; jsonify
  end
end</code></pre>
<p>Now lets look in depth at the <code class="inline">select_cat_info</code> function. Again, this function is taking one form of data and transforming it into another, but we can think of it in terms of parsing. We can assume that the function is passed a list of tuples, each containing an atom and another piece of information.</p>
<p>We want only the information about cats, which are all tagged either <code class="inline">:cat</code> or <code class="inline">:feline</code>. We have some additional requirements. Anything tagged <code class="inline">:food</code> that comes before a <code class="inline">:feline</code> tag needs to also be included, as does anything tagged <code class="inline">:grooming</code> that comes after a <code class="inline">:cat</code> tag.</p>
<p>Doing this in an object oriented language seems like it might be daunting. It obviously involves looping over the array and picking out the values tagged with either <code class="inline">:cat</code> or <code class="inline">:feline</code>. The difficult part becomes picking out the preceding or trailing tags based on the rules given. When we see <code class="inline">:food</code>, we have to keep track of it just incase the next item has a <code class="inline">:feline</code> tag.</p>
<p>It’s the edge cases that make these problems difficult.</p>
<p>When we move to a parsing solution, the edge cases can be clearly described and don’t seem out of place at all. We can solve this problem as follows:</p>
<pre><code>defmodule My.Api do

  def select_cat_info(record), do: _select_cat_info(record, [])

  defp _select_cat_info([], output), do: output

  defp _select_cat_info([{ :food, v1 }, { :feline, v2 } | tail], output),
    do: _select_cat_info(tail, output ++ [{ :food, v1 }, { :feline, v2 }])

  defp _select_cat_info([{ :cat, v1 }, { :grooming, v2 } | tail], output),
    do: _select_cat_info(tail, output ++ [{ :cat, v1 }, { :grooming, v2 }])

  defp _select_cat_info([{ :cat, v } | tail], output),
    do: _select_cat_info(tail, output ++ [{ :cat, v }])

  defp _select_cat_info([{ :feline, v } | tail], output),
    do: _select_cat_info(tail, output ++ [{ :feline, v }])

  defp _select_cat_info([ _ | tail ], output),
    do: _select_cat_info(tail, output)

end</code></pre>
<p>These function definitions are quite lengthy, and I’m sure that we could clean them up, but the basic idea is there. We’ve got a list of items, and we’re adding them into the output list based upon the 4 given rules. The other functions include the termination case (when the input list is finally empty), and the default case, which ignores the item that matches none of the above rules, and looks again at the tail of the list.</p>
<p>How do we handle error cases?</p>
<p>This technique also makes these error cases quite explicit. Using pattern matching and multiple function definitions, we can be clear about our error cases without polluting our main parsing code with if statements checking for pre-conditions.</p>
<pre><code>def select_cat_info(nil), do: error(&quot;Cannot select cat info from a nil record&quot;)
def select_cat_info(record) do
  ...
end

def error(msg), do: raise Error, message: msg</code></pre>
<p>Thinking about code in terms of data transformation and parsing certainly twisted my brain, but once I’d got my head around it, it was surprisingly effective. In the cases I’ve used the technique, I was able to quickly come to a solution that was obvious, but also obviously correct. I had one test case, and code which performed it’s job for all cases, ensuring that every additional test went green straight away. It was an odd, but refreshing, feeling.</p>

</div>

        </div>
        <div class="four columns omega">
          <div class="sidebar-item">
            <ul class="nav">
              <ul><a href="about.html">About me</a></ul>
              <!-- <ul><a href="projects.html">Projects</a></ul> -->
            </ul>
          </div>

          <div class="sidebar-item">
            <ul class="nav">
              <ul><a href="http://elixirquiz.github.io" target="_">Elixir Quiz</a></ul>
              <ul><a href="http://github.com/bennyhallett/obelisk" target="_">Obelisk</a></ul>
              <ul><a href="http://github.com/bennyhallett/anubis" target="_">Anubis</a></ul>
              <ul><a href="http://github.com/bennyhallett/elixir-rss" target="_">Elixir RSS</a></ul>
            </ul>
          </div>

          <div class="sidebar-item find-me">
            <a href="http://twitter.com/bennyhallett" target="_"><i class="fa fa-twitter fa-2x"></i></a>
            <a href="http://github.com/bennyhallett" target="_"><i class="fa fa-github fa-2x"></i></a>
            <a href="http://stackoverflow.com/users/109246/benny" target="_"><i class="fa fa-stack-overflow fa-2x"></i></a>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
